/** * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements.  See the NOTICE file * distributed with this work for additional information * regarding copyright ownership.  The ASF licenses this file * to you under the Apache License, Version 2.0 (the * "License"); you may not use this file except in compliance * with the License.  You may obtain a copy of the License at * <p> * http://www.apache.org/licenses/LICENSE-2.0 * <p> * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */package com.qlangtech.tis.extension;import com.alibaba.citrus.turbine.Context;import com.alibaba.fastjson.JSONArray;import com.alibaba.fastjson.JSONObject;import com.google.common.collect.Lists;import com.qlangtech.tis.plugin.IPluginStore;import com.qlangtech.tis.runtime.module.misc.IControlMsgHandler;import com.qlangtech.tis.util.AttrValMap;import com.qlangtech.tis.util.DefaultDescriptorsJSON;import com.qlangtech.tis.util.DescribableJSON;import com.qlangtech.tis.util.IPluginContext;import org.apache.commons.collections.CollectionUtils;import java.util.ArrayList;import java.util.Collections;import java.util.List;import java.util.Objects;import java.util.Optional;/** * 支持多步骤完成的插件配置,其中的一个子步骤 * * @author 百岁 (baisui@qlangtech.com) * @date 2026/1/13 */public abstract class OneStepOfMultiSteps implements Describable<OneStepOfMultiSteps>,        IPluginStore.ManipuldateProcessor {    public enum Step {        Step1(0), Step2(1), Step3(2), Step4(3), Step5(4), Step6(5), Step7(6);        private final int stepIndex;        private Step(int stepIndex) {            this.stepIndex = stepIndex;        }        public int getStepIndex() {            return stepIndex;        }    }    /**     * 取得上一步插件的对象实例     *     * @param pluginClass     * @param <T>     * @return     */    public static <T extends OneStepOfMultiSteps> T getPreviousStepInstance(Class<T> pluginClass) {        IPluginContext pluginContext = IPluginContext.getThreadLocalInstance();        return Objects.requireNonNull(pluginClass.cast(pluginContext.getContext().get(pluginClass.getName())),                "previous step plugin for pluginClass:" + pluginClass + " can not be nullt");    }    @Override    public Descriptor<OneStepOfMultiSteps> getDescriptor() {        Descriptor<OneStepOfMultiSteps> descriptor = Describable.super.getDescriptor();        if (!BasicDesc.class.isAssignableFrom(descriptor.getClass())) {            throw new IllegalStateException("descriptor:" + descriptor.getClass().getName() + " must exetend from " + BasicDesc.class.getName());        }        return descriptor;    }    private static final String KEY_NEXT_STEP_PLUGIN_DESC = "nextStepPluginDesc";    private static final String KEY_NEXT_STEP_PLUGIN_INDEX = "nextStepPluginIndex";    private static final String KEY_FINAL_STEP = "finalStep";    private static final String KEY_CURRENT_SAVED = "currentSaved";    private static final String KEY_CURRENT_STEP_INDEX = "currentStepIndex";    // 对应前几步保存的plugin内容    private static final String KEY_STEP_SAVED_PLUGIN = "stepSavedPlugin";    @Override    public final void manipuldateProcess(IPluginContext pluginContext, Optional<Context> context) {        try {            Context currentCtx = context.orElseThrow();            JSONObject postContent = pluginContext.getJSONPostContent();            JSONArray preStepSavedPlugin = postContent.getJSONArray(KEY_STEP_SAVED_PLUGIN);            if (CollectionUtils.isNotEmpty(preStepSavedPlugin)) {                // 获取前几步的已经保存的plugin                OneStepOfMultiSteps[] preSavedStepPlugins = new OneStepOfMultiSteps[50];                for (int i = 0; i < preStepSavedPlugin.size(); i = i + 2) {                    int index = preStepSavedPlugin.getIntValue(i);                    JSONObject item = preStepSavedPlugin.getJSONObject(i + 1);                    preSavedStepPlugins[index] =                            (OneStepOfMultiSteps) AttrValMap.parseDescribableMap(Optional.empty(), item)//                            .createDescribable((IControlMsgHandler) pluginContext, currentCtx).getInstance();                }                this.processPreSaved(pluginContext, currentCtx, preSavedStepPlugins);            }            currentCtx.put(this.getClass().getName(), this);            // this.processPluginContext(pluginContext, currentCtx);            final BasicDesc descriptor = (BasicDesc) this.getDescriptor();            Optional<BasicDesc> nextPluginDesc = descriptor.nextPluginDesc();            JSONObject saved = new JSONObject();            @SuppressWarnings("all") DescribableJSON pluginJSON = new DescribableJSON(this, descriptor);            saved.put(KEY_CURRENT_SAVED, pluginJSON.getItemJson());            if (nextPluginDesc.isPresent()) {                BasicDesc nextDesc = nextPluginDesc.get();                @SuppressWarnings("all") DefaultDescriptorsJSON desc2Json = new DefaultDescriptorsJSON(nextDesc);                saved.put(KEY_NEXT_STEP_PLUGIN_DESC, desc2Json.getDescriptorsJSON());                saved.put(KEY_NEXT_STEP_PLUGIN_INDEX, nextDesc.getStep().stepIndex);            } else {                saved.put(KEY_FINAL_STEP, true);            }            saved.put(KEY_CURRENT_STEP_INDEX, descriptor.getStep().stepIndex);            pluginContext.setBizResult(currentCtx, saved);        } catch (Exception e) {            throw new RuntimeException(e);        }    }    protected void processPreSaved(//                                   IPluginContext pluginContext, Context currentCtx,                                   OneStepOfMultiSteps[] preSavedStepPlugins) {    }    public static abstract class BasicDesc extends Descriptor<OneStepOfMultiSteps> {        public BasicDesc() {            super();        }        /**         * step枚举         *         * @return         */        public abstract Step getStep();        /**         * 下一步骤插件的descriptor，如果已经是最后一步的话则为kong         *         * @return         */        public abstract Optional<OneStepOfMultiSteps.BasicDesc> nextPluginDesc();        /**         * 获取步骤描述         *         * @return         */        public abstract String getStepDescription();    }}