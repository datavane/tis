/** * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements.  See the NOTICE file * distributed with this work for additional information * regarding copyright ownership.  The ASF licenses this file * to you under the Apache License, Version 2.0 (the * "License"); you may not use this file except in compliance * with the License.  You may obtain a copy of the License at * <p> * http://www.apache.org/licenses/LICENSE-2.0 * <p> * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */package com.qlangtech.tis.extension.impl;import com.alibaba.citrus.turbine.Context;import com.alibaba.fastjson.JSON;import com.alibaba.fastjson.JSONArray;import com.alibaba.fastjson.JSONObject;import com.qlangtech.tis.extension.Descriptor;import com.qlangtech.tis.extension.MultiStepsSupportHost;import com.qlangtech.tis.extension.MultiStepsSupportHostDescriptor;import com.qlangtech.tis.extension.OneStepOfMultiSteps;import com.qlangtech.tis.extension.PluginFormProperties;import com.qlangtech.tis.util.DefaultDescriptorsJSON;import com.qlangtech.tis.util.DescribableJSON;import com.qlangtech.tis.util.DescriptorsJSON;import com.qlangtech.tis.util.DescriptorsJSONForAIPrompt;import com.qlangtech.tis.util.IPluginContext;import org.apache.commons.lang3.ArrayUtils;import java.util.List;import java.util.Map;import java.util.Set;import static com.qlangtech.tis.extension.MultiStepsSupportHost.KEY_MULTI_STEPS_SAVED_ITEMS;/** * @author 百岁 (baisui@qlangtech.com) * @date 2026/1/21 * @see MultiStepsSupportHost 类型的插件没有属性，只需要把内部的getMultiStepsSavedItems() 属性提供给前端组件就行 */public class MultiStepsHostPluginFormProperties extends PluginFormProperties {    private final MultiStepsSupportHostDescriptor descriptor;    public MultiStepsHostPluginFormProperties(Descriptor descriptor) {        this.descriptor = (MultiStepsSupportHostDescriptor) descriptor;    }    @Override    public Descriptor getDescriptor() {        return (Descriptor) descriptor;    }    @Override    public boolean containProperty(String fieldName) {        return false;    }    @Override    public Set<Map.Entry<String, PropertyType>> getKVTuples() {        return Set.of();    }//    public static boolean containUpdateMultiStepsContext(Context context) {//        Boolean contain = (Boolean) context.get(MultiStepsHostPluginFormProperties.class.getName());//        return contain != null && contain;//    }    @Override    public JSON getInstancePropsJson(Object instance) {        try {            JSONObject vals = new JSONObject();            MultiStepsSupportHost stepsHost = (MultiStepsSupportHost) instance;            /** =========================             * start： 将当前的多步骤插件实例设置到context上下文中，可以让对应desc生成时候可以获得需要的上下文             */            IPluginContext threadLocalInstance = IPluginContext.getThreadLocalInstance();            Context context = threadLocalInstance.getContext();           // context.put(MultiStepsHostPluginFormProperties.class.getName(), Boolean.TRUE);            OneStepOfMultiSteps[] multiSteps = stepsHost.getMultiStepsSavedItems();            if (ArrayUtils.isEmpty(multiSteps)) {                throw new IllegalStateException("multiSteps can not be null");            }            OneStepOfMultiSteps[] allSteps = new OneStepOfMultiSteps[multiSteps.length];            ArrayUtils.arraycopy(multiSteps, 0, allSteps, 0, multiSteps.length);            for (OneStepOfMultiSteps childStep : multiSteps) {                childStep.processCurrentStep(threadLocalInstance, context, allSteps);            }            // 说明当前是更新状态，之前已经执行过 @MultiStepsHostPluginFormProperties.getInstancePropsJson() 方法了            DescriptorsJSON des2Json = new DefaultDescriptorsJSON(this.getStepDescriptionList());            // multiStepsCfg.put("allStepDesc", des2Json.getDescriptorsJSON());            vals.put("allStepDesc", des2Json.getDescriptorsJSON());            /**             * end =====================             */            JSONArray stepsItem = new JSONArray();            for (OneStepOfMultiSteps step : stepsHost.getMultiStepsSavedItems()) {                DescribableJSON s = new DescribableJSON(step);                stepsItem.add(s.getItemJson());            }            vals.put(MultiStepsSupportHost.KEY_MULTI_STEPS_SAVED_ITEMS, stepsItem);            return (vals);        } catch (Exception e) {            throw new RuntimeException(e);        }        //        try {        //            Object o = null;        //            for (Map.Entry<String, PropertyType> entry : propertiesType.entrySet()) {        //        //                o = entry.getValue().getFrontendOutput(instance);        //                if (o == null) {        //                    continue;        //                }        //                if (entry.getValue().isDescribable()) {        //                    DescribableJSON djson = new DescribableJSON((Describable) o);        //                    vals.put(entry.getKey(), djson.getItemJson());        //                } else {        //        //        //                    vals.put(entry.getKey(), o);        //                }        //            }        //        } catch (Exception e) {        //            throw new RuntimeException("fetchKeys:" + propertiesType.keySet().stream().collect(Collectors        //            .joining(",")) + "，hasKeys:" + Arrays.stream(instance.getClass().getFields()).map((r) -> r        //            .getName()).collect(Collectors.joining(",")), e);        //        }    }    //    /**    //     * 是否支持多步骤配置插件    //     *    //     * @return    //     * @see MultiStepsSupportHostDescriptor  Descriptor需要实现该接口    //     */    //    public boolean isSupportMultiStep() {    //        return isSupportMultiStep;    //    }    public final List<OneStepOfMultiSteps.BasicDesc> getStepDescriptionList() {        return descriptor.getStepDescriptionList();    }    @Override    public <T> T accept(IVisitor visitor) {        return visitor.visitMultiStepsHost(this);    }}