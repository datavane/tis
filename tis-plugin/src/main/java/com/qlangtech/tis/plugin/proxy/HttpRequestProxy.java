/** * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements.  See the NOTICE file * distributed with this work for additional information * regarding copyright ownership.  The ASF licenses this file * to you under the Apache License, Version 2.0 (the * "License"); you may not use this file except in compliance * with the License.  You may obtain a copy of the License at * <p> * http://www.apache.org/licenses/LICENSE-2.0 * <p> * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */package com.qlangtech.tis.plugin.proxy;import com.alibaba.citrus.turbine.Context;import com.qlangtech.tis.config.ParamsConfig;import com.qlangtech.tis.extension.TISExtension;import com.qlangtech.tis.manage.common.IURLConnectionSender;import com.qlangtech.tis.plugin.IPluginStore;import com.qlangtech.tis.plugin.annotation.FormField;import com.qlangtech.tis.plugin.annotation.FormFieldType;import com.qlangtech.tis.plugin.annotation.Validator;import com.qlangtech.tis.util.IPluginContext;import java.net.InetSocketAddress;import java.net.Proxy;import java.net.ProxySelector;import java.net.http.HttpClient;import java.util.Optional;/** * * @author 百岁 (baisui@qlangtech.com) * @date 2025/12/12 */public class HttpRequestProxy extends ParamsConfig implements IURLConnectionSender, IPluginStore.AfterPluginSaved,        IPluginStore.AfterPluginDeleted {    public static final String ConfigType = "Http-Proxy";    @FormField(identity = true, type = FormFieldType.INPUTTEXT, ordinal = 0, validate = {Validator.require,            Validator.identity})    public String name;    @FormField(type = FormFieldType.INPUTTEXT, ordinal = 2, validate = {Validator.require, Validator.hostWithoutPort})    public String proxyHost;    @FormField(type = FormFieldType.INPUTTEXT, ordinal = 3, validate = {Validator.require, Validator.integer})    public Integer proxyPort;    @FormField(ordinal = 4, validate = {Validator.require, Validator.integer})    public HttpRequestProxyAuth auth;    private transient Proxy _proxy;    private Proxy getProxy() {        if (this._proxy == null) {            _proxy = new Proxy(Proxy.Type.HTTP, new InetSocketAddress(proxyHost, proxyPort));        }        return _proxy;    }    @Override    public HttpRequestProxy createConfigInstance() {        return this;    }    @Override    public String identityValue() {        return name;    }    @Override    public void afterSaved(IPluginContext pluginContext, Optional<Context> context) {        IURLConnectionSender.sender[0] = this;        this._proxy = null;    }    @Override    public HttpClient.Builder setHttpClientBuilder(HttpClient.Builder clientBuilder, boolean skipProxy) {        if (skipProxy) {            return clientBuilder;        }        clientBuilder.proxy(ProxySelector.of(new InetSocketAddress(this.proxyHost, this.proxyPort)));        auth.setHttpClientBuilder(clientBuilder);        return clientBuilder;    }    /**     * 插件被删除之后     *     * @param pluginContext     * @param context     */    @Override    public void afterDeleted(IPluginContext pluginContext, Optional<Context> context) {        IURLConnectionSender.sender[0] = new IURLConnectionSender() {            @Override            public HttpClient.Builder setHttpClientBuilder(HttpClient.Builder clientBuilder, boolean skipProxy) {                return clientBuilder;            }        };    }    @TISExtension    public static class DefaultHttpRequestProxyDescriptor extends BasicParamsConfigDescriptor {        public DefaultHttpRequestProxyDescriptor() {            super(ConfigType);        }    }}