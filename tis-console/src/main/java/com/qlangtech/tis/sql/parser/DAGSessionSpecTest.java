/** * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements.  See the NOTICE file * distributed with this work for additional information * regarding copyright ownership.  The ASF licenses this file * to you under the Apache License, Version 2.0 (the * "License"); you may not use this file except in compliance * with the License.  You may obtain a copy of the License at * <p> * http://www.apache.org/licenses/LICENSE-2.0 * <p> * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */package com.qlangtech.tis.sql.parser;import com.alibaba.citrus.turbine.Context;import com.qlangtech.tis.build.task.IBuildHistory;import com.qlangtech.tis.coredefine.module.action.TriggerBuildResult;import com.qlangtech.tis.datax.DataXJobInfo;import com.qlangtech.tis.datax.DataXJobSubmit;import com.qlangtech.tis.datax.DataXName;import com.qlangtech.tis.datax.IDataXJobInfo;import com.qlangtech.tis.datax.IDataxProcessor;import com.qlangtech.tis.datax.impl.DataXCfgGenerator;import com.qlangtech.tis.datax.impl.DataxProcessor;import com.qlangtech.tis.exec.IExecChainContext;import com.qlangtech.tis.exec.impl.DataXPipelineExecContext;import com.qlangtech.tis.fullbuild.indexbuild.IRemoteDumpTaskTrigger;import com.qlangtech.tis.fullbuild.indexbuild.RemoteTaskTriggers;import com.qlangtech.tis.fullbuild.phasestatus.PhaseStatusCollection;import com.qlangtech.tis.job.common.JobCommon;import com.qlangtech.tis.runtime.module.misc.IControlMsgHandler;import com.qlangtech.tis.workflow.pojo.IWorkflow;import com.qlangtech.tis.workflow.pojo.WorkFlowBuildHistory;import com.tis.hadoop.rpc.RpcServiceReference;import com.tis.hadoop.rpc.StatusRpcClientFactory;import junit.framework.TestCase;import org.junit.Assert;import java.util.Objects;import java.util.Optional;/** * * @author 百岁 (baisui@qlangtech.com) * @date 2026/2/2 */public class DAGSessionSpecTest extends TestCase {  static final String testDataXName = "mysql_mysql";  public void testCreateDAGSessionSpec() {    Long triggerTimestamp = -1L;    DataXName mysql2Mysql = DataXName.createDataXPipeline(testDataXName);    DataXPipelineExecContext execChainContext = new DataXPipelineExecContext(mysql2Mysql.getPipelineName(),      triggerTimestamp);    execChainContext.setAttribute(JobCommon.KEY_TASK_ID, 999);    RemoteTaskTriggers taskTriggers = new RemoteTaskTriggers();    execChainContext.setTskTriggers(taskTriggers);    DataXJobSubmit jobSubmit = new MockDataXJobSubmit();    IDataxProcessor dataxProcessor = DataxProcessor.load(null, mysql2Mysql);    DataXCfgGenerator.GenerateCfgs cfgFileNames = dataxProcessor.getDataxCfgFileNames(null,      com.qlangtech.tis.plugin.trigger.JobTrigger.getTriggerFromHttpParam(execChainContext));    DAGSessionSpec sessionSpec = DAGSessionSpec.createDAGSessionSpec(execChainContext,      StatusRpcClientFactory.getMockStub(), dataxProcessor, cfgFileNames, jobSubmit).getLeft();    System.out.println(sessionSpec.buildSpec());    Assert.assertNotNull(sessionSpec.getDAG());  }  private static class MockDataXJobSubmit extends DataXJobSubmit {    @Override    public InstanceType getType() {      return null;    }    @Override    public TriggerBuildResult triggerJob(DataXName appName, Optional<PhaseStatusCollection> latestWorkflowHistory) {      return null;    }    @Override    public TriggerBuildResult triggerWorkflowJob(IControlMsgHandler module, Context context, IWorkflow workflow,                                                 Boolean dryRun,                                                 Optional<WorkFlowBuildHistory> latestSuccessWorkflowHistory) {      return null;    }    @Override    public boolean cancelTask(IControlMsgHandler module, Context context, IBuildHistory buildHistory) {      return false;    }    @Override    public IRemoteDumpTaskTrigger createDataXJob(IDataXJobContext taskContext, RpcServiceReference statusRpc,                                                 DataXJobInfo jobName, IDataxProcessor dataxProcessor) {      return new IRemoteDumpTaskTrigger() {        @Override        public String getTaskName() {          return jobName.jobFileName;        }        @Override        public IDataXJobInfo getDataXTaskMessage() {          return Objects.requireNonNull(jobName, "jobName can not be null");        }        @Override        public void run() {        }      };    }    @Override    public IDataXJobContext createJobContext(IExecChainContext parentContext) {      return IDataXJobContext.create(parentContext);    }  }}