## ADDED Requirements

### Requirement: 实时工作流状态查询

系统 SHALL 提供实时查询工作流执行状态的接口，展示 DAG 的整体执行情况。

#### Scenario: 查询工作流实例状态

- **WHEN** 用户请求查询某个工作流实例的状态
- **THEN** 系统返回工作流的整体状态（WAITING/RUNNING/SUCCEED/FAILED/STOPPED）、开始时间、更新时间

#### Scenario: 查询工作流节点状态

- **WHEN** 用户请求查询工作流实例的节点状态
- **THEN** 系统返回所有节点的状态列表，包括节点 ID、名称、状态、开始时间、完成时间

#### Scenario: 查询工作流上下文

- **WHEN** 用户请求查询工作流实例的上下文数据
- **THEN** 系统返回 wf_context 中的所有键值对

### Requirement: 等待队列监控

系统 SHALL 提供等待队列的监控接口，展示所有等待执行的节点。

#### Scenario: 查询所有等待节点

- **WHEN** 用户请求查询等待队列
- **THEN** 系统返回所有状态为 WAITING 的节点列表，包括工作流实例 ID、节点 ID、节点名称、等待时长

#### Scenario: 按工作流过滤等待节点

- **WHEN** 用户请求查询某个工作流的等待节点
- **THEN** 系统返回该工作流实例中所有状态为 WAITING 的节点

#### Scenario: 等待队列统计

- **WHEN** 用户请求查询等待队列统计
- **THEN** 系统返回等待节点总数、按工作流分组的等待节点数量

### Requirement: 执行队列监控

系统 SHALL 提供执行队列的监控接口，展示所有正在执行的节点。

#### Scenario: 查询所有运行节点

- **WHEN** 用户请求查询执行队列
- **THEN** 系统返回所有状态为 RUNNING 的节点列表，包括工作流实例 ID、节点 ID、节点名称、执行时长、Worker 地址

#### Scenario: 按 Worker 过滤运行节点

- **WHEN** 用户请求查询某个 Worker 上运行的节点
- **THEN** 系统返回该 Worker 上所有状态为 RUNNING 的节点

#### Scenario: 执行队列统计

- **WHEN** 用户请求查询执行队列统计
- **THEN** 系统返回运行节点总数、按 Worker 分组的运行节点数量、平均执行时长

### Requirement: DAG 可视化展示

系统 SHALL 提供 DAG 的可视化展示接口，以图形方式展示节点和依赖关系。

#### Scenario: 获取 DAG 拓扑结构

- **WHEN** 用户请求查看工作流的 DAG 拓扑
- **THEN** 系统返回节点列表和边列表，供前端渲染 DAG 图

#### Scenario: 节点状态着色

- **WHEN** 用户查看正在执行的工作流的 DAG 图
- **THEN** 系统返回每个节点的当前状态，前端根据状态着色（WAITING=灰色、RUNNING=蓝色、SUCCEED=绿色、FAILED=红色）

#### Scenario: 高亮关键路径

- **WHEN** 用户请求查看 DAG 的关键路径
- **THEN** 系统计算并返回关键路径上的节点列表，前端高亮显示

### Requirement: 节点执行详情查询

系统 SHALL 提供节点执行详情的查询接口，展示节点的执行日志和结果。

#### Scenario: 查询节点执行记录

- **WHEN** 用户请求查询某个节点的执行记录
- **THEN** 系统返回节点的执行状态、开始时间、完成时间、执行结果、Worker 地址

#### Scenario: 查询节点执行日志

- **WHEN** 用户请求查询某个节点的执行日志
- **THEN** 系统返回节点执行过程中的日志输出

#### Scenario: 查询节点重试历史

- **WHEN** 用户请求查询某个节点的重试历史
- **THEN** 系统返回节点的所有重试记录，包括重试次数、每次重试的开始时间、完成时间和结果

### Requirement: 工作流执行历史查询

系统 SHALL 提供工作流执行历史的查询接口，支持分页和过滤。

#### Scenario: 查询工作流所有实例

- **WHEN** 用户请求查询某个工作流的所有实例
- **THEN** 系统返回该工作流的所有实例列表，按创建时间倒序排列，支持分页

#### Scenario: 按状态过滤实例

- **WHEN** 用户请求查询某个工作流的失败实例
- **THEN** 系统返回该工作流所有状态为 FAILED 的实例列表

#### Scenario: 按时间范围过滤实例

- **WHEN** 用户请求查询某个时间范围内的工作流实例
- **THEN** 系统返回该时间范围内创建的所有工作流实例

### Requirement: 实时监控推送

系统 SHALL 支持通过 WebSocket 推送工作流执行状态的实时更新。

#### Scenario: 订阅工作流实例

- **WHEN** 用户在前端打开某个工作流实例的监控页面
- **THEN** 系统建立 WebSocket 连接，订阅该工作流实例的状态更新

#### Scenario: 推送节点状态变化

- **WHEN** 工作流实例中某个节点的状态发生变化
- **THEN** 系统通过 WebSocket 推送状态变化事件到前端，前端实时更新 DAG 图

#### Scenario: 推送工作流完成事件

- **WHEN** 工作流实例执行完成
- **THEN** 系统通过 WebSocket 推送完成事件到前端，前端显示最终结果

### Requirement: 监控指标统计

系统 SHALL 提供工作流执行的统计指标，支持性能分析和优化。

#### Scenario: 查询工作流执行统计

- **WHEN** 用户请求查询某个工作流的执行统计
- **THEN** 系统返回总执行次数、成功次数、失败次数、平均执行时长、最长执行时长

#### Scenario: 查询节点执行统计

- **WHEN** 用户请求查询某个节点的执行统计
- **THEN** 系统返回该节点的总执行次数、成功次数、失败次数、平均执行时长

#### Scenario: 查询集群负载统计

- **WHEN** 用户请求查询集群负载统计
- **THEN** 系统返回每个 Worker 的任务执行数量、CPU 使用率、内存使用率

### Requirement: 告警通知

系统 SHALL 支持工作流执行异常时的告警通知。

#### Scenario: 工作流执行失败告警

- **WHEN** 工作流实例执行失败
- **THEN** 系统发送告警通知（邮件/钉钉/企业微信），包含工作流名称、实例 ID、失败原因

#### Scenario: 节点执行超时告警

- **WHEN** 节点执行时间超过配置的告警阈值
- **THEN** 系统发送告警通知，提示节点执行时间过长

#### Scenario: 集群节点下线告警

- **WHEN** 集群中某个节点下线
- **THEN** 系统发送告警通知，提示节点不可用

### Requirement: 监控数据导出

系统 SHALL 支持导出工作流执行数据，用于离线分析。

#### Scenario: 导出工作流实例列表

- **WHEN** 用户请求导出工作流实例列表
- **THEN** 系统生成 CSV 文件，包含所有实例的基本信息

#### Scenario: 导出节点执行详情

- **WHEN** 用户请求导出某个工作流实例的节点执行详情
- **THEN** 系统生成 CSV 文件，包含所有节点的执行记录

#### Scenario: 导出执行统计报表

- **WHEN** 用户请求导出执行统计报表
- **THEN** 系统生成 Excel 文件，包含工作流和节点的统计指标
